# 팀별 MCP 서버 관리 시스템 가이드

## 개요

Microsoft Graph 패턴을 차용한 팀별 MCP 서버 접근 시스템이 구현되었습니다. 이 시스템은 조직(팀) ID를 기반으로 안정적인 URL을 제공하며, 팀명 변경과 무관하게 일관된 접근을 보장합니다.

## 주요 기능

### 1. 팀별 라우팅 시스템

#### 새로운 URL 구조
```
http://localhost:8000/{teamId}/servers/{serverId}/sse
```

#### 기존 호환성 유지
```
http://localhost:8000/sse/{serverId}  # 기존 방식 계속 지원
```

### 2. 주요 엔드포인트

#### SSE 연결
- **GET** `/{team_id}/servers/{server_name}/sse`
  - 팀별 서버 SSE 연결
  - Authorization 헤더 필요: `Bearer {api_key}`

#### 메시지 전송
- **POST** `/{team_id}/servers/{server_name}/messages`
  - 팀별 서버 메시지 전송
  - JSON-RPC 요청 처리

#### Discovery Endpoint
- **GET** `/{team_id}/.well-known/mcp-servers`
  - Microsoft Graph 스타일 서버 자동 발견
  - 팀별 접근 가능한 서버 목록 반환

#### API 키 관리
- **GET** `/api/teams/{team_id}/api-keys`
  - 팀별 API 키 목록 조회
- **POST** `/api/teams/{team_id}/api-keys`
  - 팀별 API 키 생성

#### Cline 설정 생성
- **GET** `/api/teams/{team_id}/cline-config`
  - 팀별 Cline 설정 파일 자동 생성

## 사용 방법

### 1. 조직 ID 확인

먼저 조직의 UUID를 확인해야 합니다:

```sql
SELECT id, name FROM organizations;
```

예시 결과:
```
id: 550e8400-e29b-41d4-a716-446655440000
name: "John's Organization"
```

### 2. API 키 생성

팀별 API 키를 생성합니다:

```bash
curl -X POST "http://localhost:8000/api/teams/550e8400-e29b-41d4-a716-446655440000/api-keys" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer existing_api_key" \
  -d '{
    "name": "Team Development Key",
    "permissions": {}
  }'
```

응답 예시:
```json
{
  "id": "api-key-uuid",
  "name": "Team Development Key",
  "api_key": "mcp_abc123def456...",
  "key_prefix": "mcp_abc123",
  "is_active": true,
  "permissions": {},
  "message": "API key created successfully. Please save it securely as it won't be shown again."
}
```

### 3. Cline 설정 생성

팀별 Cline 설정을 자동 생성합니다:

```bash
curl -X GET "http://localhost:8000/api/teams/550e8400-e29b-41d4-a716-446655440000/cline-config" \
  -H "Authorization: Bearer mcp_abc123def456..."
```

응답 예시:
```json
{
  "team_id": "550e8400-e29b-41d4-a716-446655440000",
  "organization_name": "John's Organization",
  "config": {
    "mcpServers": {
      "excel-server": {
        "transport": "sse",
        "url": "http://localhost:8000/550e8400-e29b-41d4-a716-446655440000/servers/excel-server/sse",
        "headers": {
          "Authorization": "Bearer mcp_abc123..."
        }
      },
      "github-server": {
        "transport": "sse",
        "url": "http://localhost:8000/550e8400-e29b-41d4-a716-446655440000/servers/github-server/sse",
        "headers": {
          "Authorization": "Bearer mcp_abc123..."
        }
      }
    }
  },
  "instructions": [
    "1. Copy the configuration below to your Cline MCP settings",
    "2. Replace the API key with your actual key (shown only during key creation)",
    "3. Save and restart Cline to apply the changes",
    "4. Your team has access to 2 MCP servers"
  ]
}
```

### 4. Discovery Endpoint 사용

팀별 서버 정보를 자동 발견합니다:

```bash
curl -X GET "http://localhost:8000/550e8400-e29b-41d4-a716-446655440000/.well-known/mcp-servers" \
  -H "Authorization: Bearer mcp_abc123def456..."
```

응답 예시:
```json
{
  "team_id": "550e8400-e29b-41d4-a716-446655440000",
  "organization": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "name": "John's Organization"
  },
  "servers": {
    "excel-server": {
      "name": "excel-server",
      "status": "connected",
      "url": "/550e8400-e29b-41d4-a716-446655440000/servers/excel-server/sse",
      "tools": ["excel_read_sheet", "excel_write_to_sheet"],
      "description": "Excel MCP Server",
      "version": "1.0.0"
    }
  },
  "base_url": "http://localhost:8000",
  "discovery_version": "1.0.0"
}
```

## 권한 시스템

### 인증 흐름

1. **팀 ID 검증**: UUID 형식 확인
2. **API 키 검증**: Authorization 헤더에서 Bearer 토큰 추출
3. **조직 조회**: 팀 ID로 조직 존재 확인
4. **API 키 매칭**: 해시된 API 키와 조직 연결 확인
5. **서버 접근 권한**: 조직별 서버 접근 권한 확인

### 에러 응답

- **401 Unauthorized**: API 키가 없거나 잘못됨
- **403 Forbidden**: 서버 접근 권한 없음
- **404 Not Found**: 팀 또는 서버를 찾을 수 없음

## 실제 Cline 설정 예시

생성된 설정을 Cline MCP 설정에 적용:

```json
{
  "mcpServers": {
    "excel-server": {
      "transport": "sse",
      "url": "http://localhost:8000/550e8400-e29b-41d4-a716-446655440000/servers/excel-server/sse",
      "headers": {
        "Authorization": "Bearer mcp_abc123def456ghi789jkl012mno345pqr678stu901vwx234yz"
      }
    },
    "github-server": {
      "transport": "sse", 
      "url": "http://localhost:8000/550e8400-e29b-41d4-a716-446655440000/servers/github-server/sse",
      "headers": {
        "Authorization": "Bearer mcp_abc123def456ghi789jkl012mno345pqr678stu901vwx234yz"
      }
    }
  }
}
```

## 장점

### 1. URL 안정성
- 팀명 변경과 무관하게 UUID 기반 안정적인 URL 제공
- 기존 Cline 설정 변경 불필요

### 2. 권한 격리
- 팀별 독립적인 API 키 관리
- 조직 간 완전한 서버 접근 격리
- 세분화된 권한 제어

### 3. 사용 편의성
- 자동 Cline 설정 생성
- Discovery Endpoint를 통한 서버 자동 발견
- Microsoft Graph 패턴으로 직관적인 API 구조

### 4. 확장성
- 향후 팀 내 세부 권한 제어 확장 가능
- 사용량 추적 및 제한 기능 확장 가능
- 엔터프라이즈 기능 확장 기반 제공

## 다음 단계

1. **웹 UI 통합**: 팀별 API 키 관리 UI 구현
2. **사용량 추적**: 팀별 도구 사용량 모니터링
3. **세분화된 권한**: 도구별 접근 권한 제어
4. **감사 로그**: 팀별 활동 추적 및 로깅

## 문제 해결

### 일반적인 문제

1. **401 Unauthorized**
   - API 키가 올바른지 확인
   - Authorization 헤더 형식 확인: `Bearer {api_key}`

2. **404 Not Found**
   - 팀 ID가 올바른 UUID 형식인지 확인
   - 조직이 실제로 존재하는지 확인

3. **403 Forbidden**
   - API 키가 해당 조직에 속하는지 확인
   - 서버 접근 권한이 있는지 확인

### 디버깅

로그에서 다음 메시지들을 확인:
```
INFO: Team access verified: John's Organization (550e8400-e29b-41d4-a716-446655440000)
INFO: Server access granted: excel-server for org 550e8400-e29b-41d4-a716-446655440000
```

## 결론

팀별 MCP 서버 관리 시스템은 Microsoft Graph 패턴을 차용하여 안정적이고 확장 가능한 팀 기반 MCP 서버 접근을 제공합니다. 이 시스템을 통해 조직은 팀별로 독립적인 MCP 서버 환경을 구축하고 관리할 수 있습니다.
